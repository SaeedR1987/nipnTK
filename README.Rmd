---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, echo = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "tools/README-"
)
```

# nipnTK: National Information Platforms for Nutrition (NiPN) data quality toolkit
[![CRAN](https://img.shields.io/cran/v/nipnTK.svg)](https://cran.r-project.org/package=nipnTK)
[![CRAN](https://img.shields.io/cran/l/nipnTK.svg)](https://CRAN.R-project.org/package=nipnTK)
[![CRAN](http://cranlogs.r-pkg.org/badges/nipnTK)](https://cran.r-project.org/package=nipnTK)
[![Travis-CI Build Status](https://travis-ci.org/validmeasures/nipnTK.svg?branch=master)](https://travis-ci.org/validmeasures/nipnTK)
[![AppVeyor Build Status](https://ci.appveyor.com/api/projects/status/github/validmeasures/nipnTK?branch=master&svg=true)](https://ci.appveyor.com/project/validmeasures/nipnTK)
[![codecov](https://codecov.io/gh/validmeasures/nipnTK/branch/master/graph/badge.svg)](https://codecov.io/gh/validmeasures/nipnTK)

[National Information Platforms for Nutrition (NIPN)](http://www.nipn-nutrition-platforms.org)
is an initiative of the European Commission to provide support to countries to 
strengthen their information systems for nutrition and to improve the analysis of 
data so as to better inform the strategic decisions they are faced with to prevent 
malnutrition and its consequences.

As part of this mandate, NiPN has commissioned work on the development of a toolkit
to assess the quality of various nutrition-specific and nutrition-related data.
This is a companion R package to the toolkit of practical analytical methods that 
can be applied to variables in datasets to assess their quality.

The focus of the toolkit is on data required to assess anthropometric status such 
as measurements of weight, height or length, MUAC, sex and age. The focus is on 
anthropometric status but many of presented methods could be applied to other 
types of data. NiPN may commission additional toolkits to examine other variables 
or other types of variables.

Data quality is assessed by:

1. Range checks and value checks to identify univariate outliers.

2. Scatterplots and statistical methods to identify bivariate outliers.

3. Use of flags to identify outliers in anthropometric indices.

4. Examining the distribution and the statistics of the distribution of 
measurements and anthropometric indices.

5. Assessing the extent of digit preference in recorded measurements. Assessing 
the extent of age heaping in recorded ages.

6. Examining the sex ratio.

7. Examining age distributions and age by sex distributions.


## Requirements

* R version 3.4 or higher

Extensive use is made of the R language and environment for statistical computing. 
This is a free and powerful data analysis system. R provides a very extensive 
language for working with data. This companion package has been written using 
only a small subset of the R language. Many of the data quality activities 
described in the toolkit are supported by R functions included in this package
that have been written specifically for this purpose. These simplify the assessment 
of the quality of data related to anthropometry and anthropometric indices.


## Installation

You can install the development version of nipnTK from github with:

```{r gh-installation, eval = FALSE}
# install.packages("devtools")
devtools::install_github("validmeasures/nipnTK")
```


## Usage

### 1. Range checks and value checks to identify univariate outliers.

Checking that data are within an acceptable or plausible range is an important 
basic check to apply to quantitative data. Checking that data are recorded with 
appropriate legal values or codes is an important basic check to apply to 
categorical data.

```{r eval = TRUE, echo = TRUE}
# Load nipnTK package
library(nipnTK)

# Assign dataset rl.ex01 to svy
svy <- rl.ex01

# Summarise MUAC variable
summary(svy$muac)
```

```{r eval = TRUE, echo = TRUE}
# Boxplot of MUAC values
boxplot(svy$muac, horizontal = TRUE, xlab = "MUAC (mm)", frame.plot = FALSE)
```

```{r eval = TRUE, echo = TRUE}
# Use outliersUV() function to identify outliers
svy[outliersUV(svy$muac), ]
```


### 2. Scatterplots and statistical methods to identify bivariate outliers.


```{r eval = TRUE, echo = TRUE}
# Retrieve sp.ex01 data and assign to svy
svy <- sp.ex01
```

```{r eval = TRUE, echo = TRUE}
# Look at the relationship between height and weight
plot(svy$height, svy$weight)
```

```{r eval = TRUE, echo = TRUE}
# Assess the strength of relationship using the Pearson correlation coefficient:
cor(svy$height, svy$weight, method = "pearson", use = "complete.obs")
```

This is very close to one, which indicates a perfect positive association. There 
are, however a few points that lie outside of the bulk of the plotted points. 
These outliers may be due to errors in the data. The presence of oedema can be 
associated with increased weight. This is a particular issue with severe oedema. 
An outlier with a high value of weight for a given height could be due to oedema. 
We can check this:

```{r eval = TRUE, echo = TRUE}
plot(svy$height, svy$weight, pch = ifelse(svy$oedema == 1, 19, 1))
```

A more formal method of identifying outliers is to use a measure of the 
statistical distance. A common measure of statistical distance that is applied 
to scatterplot data is the Mahalanobis distance. This treats the bivariate 
probability distribution as an ellipsoid. The Mahalanobis distance is the 
distance of a point from the centre of mass of the distribution divided by width 
of the ellipsoid in the direction of the point:

The NiPN data quality toolkit provides an R language function `outliersMD()` that 
uses the Mahalanobis distance to identify outliers in the same dataset:
```{r eval = TRUE, echo = TRUE}
svy[outliersMD(svy$height,svy$weight), ]
```

We can use the `outliersMD()` to identify and display outliers on a scatterplot: 
```{r eval = TRUE, echo = TRUE}
plot(svy$height, svy$weight, pch = ifelse(outliersMD(svy$height, svy$weight), 19, 1))
```


3. Use of flags to identify outliers in anthropometric indices.


```{r eval = TRUE, echo = TRUE}
library(nipnTK)
svy <- flag.ex01

# Set flag variable to 0
svy$flag <- 0

# Apply WHO flagging criteria to survey data
svy$flag <- ifelse(!is.na(svy$haz) & (svy$haz < -6 | svy$haz > 6), svy$flag + 1, svy$flag)
svy$flag <- ifelse(!is.na(svy$whz) & (svy$whz < -5 | svy$whz > 5), svy$flag + 2, svy$flag)
svy$flag <- ifelse(!is.na(svy$waz) & (svy$waz < -6 | svy$waz > 5), svy$flag + 4, svy$flag)
```

Note that each time we apply a flagging criteria we increase the value of the 
flagging variable by the next power of two when a problem is detected:

We started with zero

Then we added 2^0 (i.e. 1) if HAZ was out of range. 
Then we added 2^1 (i.e. 2) if WHZ was out of range. 
Then we added 2^2 (i.e. 4) if WAZ was out of range.

If we had another index then we would use 2^3 (i.e. 8) to flag a problem in that index.

The advantage of using this coding scheme is that it compactly codes all possible combinations of
problems in a single variable

4. Examining the distribution and the statistics of the distribution of 
measurements and anthropometric indices.

We will examine the distribution of anthropometric variables (e.g. weight, 
height, and MUAC), anthropometric indices (e.g. WHZ, HAZ, and WHZ), and 
anthropometric indicators (e.g. wasted, stunted, and underweight).

```{r eval = TRUE, echo = TRUE}
svy <- dist.ex01

summary(svy$weight)

sd(svy$weight)

```

The NipN data quality toolkit provides an R language function called 
`histNormal()` that can help with *“by-eye”* assessments by superimposing a normal 
curve on a histogram of the variable of interest:

```{r eval = TRUE, echo = TRUE}
histNormal(svy$muac) 
histNormal(svy$haz) 
histNormal(svy$waz) 
histNormal(svy$whz)
```

5. Assessing the extent of digit preference in recorded measurements. Assessing 
the extent of age heaping in recorded ages.

6. Examining the sex ratio.

7. Examining age distributions and age by sex distributions.

